<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8"/>
  <title>WebGIS Banten</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="icon" type="image/png" href="favicon.png">
  <style>
    html, body { 
        margin: 0; padding: 0; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; overflow: hidden;
    }
    #map { width: 100%; height: 100%; background-color: #f0f0f0; }
    #panel {
        position: absolute; top: 0; right: 0; width: 300px; height: 100%;
        background: rgba(255, 255, 255, 0.98); box-shadow: -2px 0 10px rgba(0,0,0,0.15);
        z-index: 1001; transform: translateX(100%); transition: transform 0.3s ease-in-out;
        display: flex; flex-direction: column;
    }
    #panel.open { transform: translateX(0); }
    .panel-header { padding: 15px; border-bottom: 1px solid #ddd; }
    .panel-header h3 { margin: 0; font-size: 18px; }
    .panel-content { padding: 15px; overflow-y: auto; flex-grow: 1; display: flex; flex-direction: column; gap: 20px; }
    select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; background-color: #fff; }
    label { font-weight: bold; margin-bottom: 5px; display: block; }
    input[type="range"] { width: 100%; cursor: pointer; }
    .layer-toggle { display: flex; align-items: center; gap: 10px; padding: 10px; background-color: #f0f0f0; border-radius: 6px; }
    .layer-toggle label { margin-bottom: 0; cursor: pointer; font-weight: normal; }
    .layer-toggle input[type="checkbox"] { width: 18px; height: 18px; cursor: pointer; }
    .leaflet-control-container .leaflet-top.leaflet-right { top: 15px; right: 15px; }
    .custom-map-controls { background-color: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.2); overflow: hidden; }
    .custom-map-controls a {
        display: block; width: 34px; height: 34px; line-height: 34px; text-align: center;
        font-size: 1.4em; color: #333; text-decoration: none; border-bottom: 1px solid #ddd;
    }
    .custom-map-controls a:last-child { border-bottom: none; }
    .custom-map-controls a:hover { background-color: #f4f4f4; }
    #toggle-panel { display: none; }
    #legend { position: absolute; bottom: 15px; left: 15px; z-index: 1000; background: rgba(255, 255, 255, 0.95); padding: 8px 12px; border-radius: 6px; font-size: 13px; line-height: 1.6; box-shadow: 0 2px 8px rgba(0,0,0,0.2); max-height: 40vh; overflow-y: auto; }
    .legend-item { display: flex; align-items: center; margin-bottom: 3px; }
    .legend-box { width: 18px; height: 18px; margin-right: 8px; border: 1px solid rgba(0,0,0,0.2); flex-shrink: 0; }
    .text-label {
        background: transparent; border: none; box-shadow: none;
        color: #222; font-weight: bold; font-size: 12px;
        text-shadow: 1px 1px 2px #FFFFFF, -1px 1px 2px #FFFFFF, 1px -1px 2px #FFFFFF, -1px -1px 2px #FFFFFF;
        white-space: nowrap;
    }
    @media (max-width: 768px) {
        #panel { display: flex; }
        #toggle-panel { display: block; }
    }
    @media (min-width: 769px) {
        #panel {
            width: 320px; height: auto; max-height: calc(100vh - 30px);
            top: 15px; right: 15px; transform: translateX(0);
            display: block; border-radius: 8px;
        }
    }
  </style>
</head>
<body>

<div id="map"></div>
<div id="panel">
  <div class="panel-header"><h3>Kontrol Peta</h3></div>
  <div class="panel-content">
    <div>
      <label for="zonaSelect">Pilih Zona</label>
      <select id="zonaSelect">
        <option value="">-- Tampilkan Satu Zona --</option>
      </select>
    </div>
    <!-- Tambahan dropdown bidang -->
    <div>
      <label for="bidangSelect">Pilih Bidang Tanah</label>
      <select id="bidangSelect">
        <option value="">-- Tampilkan Bidang Tanah --</option>
      </select>
    </div>
    <div>
      <label for="transparencySlider">Transparansi Zona</label>
      <input type="range" id="transparencySlider" min="0" max="1" step="0.05" value="0.7">
    </div>
    <div class="layer-toggle">
      <input type="checkbox" id="pointsToggle">
      <label for="pointsToggle">Tampilkan Titik Sampel</label>
    </div>
    <div class="layer-toggle">
      <input type="checkbox" id="labelsToggle">
      <label for="labelsToggle">Tampilkan Label Zona</label>
    </div>
  </div>
</div>
<div id="legend"><strong>Legenda</strong><div id="legendContent"></div></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
  const map = L.map('map', { zoomControl: false }).setView([-6.65, 106.25], 10);

  const baseLayers = {
      'Street Map': L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }),
      'Satelit': L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Tiles &copy; Esri' }),
      'Peta Gelap': L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '&copy; CartoDB' })
  };
  baseLayers['Street Map'].addTo(map);
  L.control.layers(baseLayers, null, { position: 'topleft' }).addTo(map);

  // kontrol custom
  L.Control.Custom = L.Control.extend({
      onAdd: function(map) {
          const container = L.DomUtil.create('div', 'leaflet-bar custom-map-controls');
          this._createButton('+', 'Perbesar', 'zoom-in', container, () => map.zoomIn());
          this._createButton('-', 'Perkecil', 'zoom-out', container, () => map.zoomOut());
          this._createButton('ðŸŽ¯', 'Cari Lokasi', 'locate-me', container, () => map.locate({ setView: true, maxZoom: 16 }));
          this._createButton('â˜°', 'Buka Panel', 'toggle-panel', container, () => document.getElementById('panel').classList.toggle('open'));
          return container;
      },
      _createButton: function(html, title, className, container, fn) {
          const link = L.DomUtil.create('a', className, container);
          link.innerHTML = html; link.href = '#'; link.title = title; link.id = className;
          L.DomEvent.on(link, 'click', L.DomEvent.stopPropagation).on(link, 'click', L.DomEvent.preventDefault).on(link, 'click', fn, this);
          return link;
      }
  });
  new L.Control.Custom({ position: 'topright' }).addTo(map);

  const DATA_DIR = 'assets/data/';
  const ID_LIST = [
    "0001_9101014211000002","0001_3326106006020004","0001_3211222201860004",
    "0001_3273021408990011","0001_3207182412940001","0001_3273140907780001",
    "0001_3273102412980001","0001_3204082908940004","0001_3272062511850001",
    "0001_1771012011920005","0001_1509040810960003","0001_3273100404010001",
    "0001_3305232905020001","0001_3204352405010006","0001_3273040905960004",
    "0001_1509042608950004","0001_3204072001990001","0001_3204351307040003",
    "0001_3204302801010002","0001_3211140411870013"
  ];

  let currentOpacity = 0.7;
  let pointsLayer = null;
  let labelsLayer = null;
  let bidangLayer = null; 
  const colorCache = {};
  const legendSet = new Set();
  const layers = {};

  function kColor(k_in){
    const k = String(k_in);
    if(colorCache[k]) return colorCache[k];
    let hash = 0;
    for (let i = 0; i < k.length; i++) hash = k.charCodeAt(i) + ((hash << 5) - hash);
    const hue = Math.abs(hash * 137.508) % 360;
    colorCache[k] = `hsl(${hue}, 75%, 60%)`;
    return colorCache[k];
  }

  function style(feature){
    return { color: '#333', weight: 1, fillColor: kColor(feature.properties.kode), fillOpacity: currentOpacity };
  }

  function updateLegend(){
    const container = document.getElementById('legendContent'); container.innerHTML = '';
    const sortedKodes = Array.from(legendSet).sort();
    sortedKodes.forEach(k => {
      const row = document.createElement('div'); row.className = 'legend-item';
      const box = document.createElement('div'); box.className = 'legend-box'; box.style.backgroundColor = kColor(k);
      const lbl = document.createElement('span'); lbl.textContent = 'Kode ' + k;
      row.appendChild(box); row.appendChild(lbl); container.appendChild(row);
    });
  }

  function remLayer(f){ if(layers[f]){ map.removeLayer(layers[f]); delete layers[f]; } }

  function addLayer(f){
    if(layers[f]) return Promise.resolve();
    return fetch(DATA_DIR + f)
      .then(res => res.json())
      .then(geo => {
        layers[f] = L.geoJSON(geo, {
          style,
          onEachFeature: (feature, layer) => {
            const k = feature.properties.kode;
            if (k) { layer.bindPopup('Kode: ' + k); legendSet.add(k); }
          }
        }).addTo(map);
        updateLegend(); map.fitBounds(layers[f].getBounds());
      })
      .catch(err => alert(`Gagal memuat file zona: ${f}`));
  }

  function toggleLabels() {
      if (!labelsLayer) return;
      labelsLayer.clearLayers();
      const labelsOn = document.getElementById('labelsToggle').checked;
      if (!labelsOn) {
          if (map.hasLayer(labelsLayer)) map.removeLayer(labelsLayer);
          return;
      }
      Object.values(layers).forEach(layer => {
          layer.eachLayer(featureLayer => {
              const props = featureLayer.feature.properties;
              if (props && props.kode) {
                  const center = featureLayer.getBounds().getCenter();
                  L.marker(center, {
                      icon: L.divIcon({ className: 'text-label', html: `<div>${props.kode}</div>` }),
                      interactive: false, pane: 'shadowPane'
                  }).addTo(labelsLayer);
              }
          });
      });
      if (!map.hasLayer(labelsLayer)) map.addLayer(labelsLayer);
  }

  function closePanelOnMobile() {
      if (window.innerWidth <= 768) {
          document.getElementById('panel').classList.remove('open');
      }
  }

  // fungsi load bidang
  function loadBidang(file){
    if(bidangLayer){ map.removeLayer(bidangLayer); bidangLayer=null; }
    if(!file) return;
    fetch(DATA_DIR+file)
      .then(res=>res.json())
      .then(data=>{
        bidangLayer = L.geoJSON(data,{
          style:{color:'#006400',weight:2,fillColor:'#90EE90',fillOpacity:0.5},
          onEachFeature:(f,l)=>{
            let luas = f.properties.luas || f.properties.LUAS || f.properties.Luas_Bidang || "-";
            l.bindPopup("<b>Bidang Tanah</b><br>Luas: "+luas+" mÂ²");
          }
        }).addTo(map);
        map.fitBounds(bidangLayer.getBounds());
      })
      .catch(err=>alert("Gagal memuat bidang: "+err));
  }

  (function init(){
    const zonaSelect = document.getElementById('zonaSelect');
    const bidangSelect = document.getElementById('bidangSelect');
    const transparencySlider = document.getElementById('transparencySlider');
    const pointsToggle = document.getElementById('pointsToggle');
    const labelsToggle = document.getElementById('labelsToggle');
    
    labelsLayer = L.layerGroup();

    ID_LIST.forEach((id,i)=>{
      let opt1=document.createElement("option");
      opt1.value=id+".geojson"; opt1.textContent="Zona "+(i+1);
      zonaSelect.appendChild(opt1);

      let opt2=document.createElement("option");
      opt2.value="persil_"+id+".geojson"; opt2.textContent="Bidang "+(i+1);
      bidangSelect.appendChild(opt2);
    });

    zonaSelect.onchange = e => {
      const v = e.target.value;
      Object.keys(layers).forEach(remLayer);
      legendSet.clear(); 
      updateLegend();
      toggleLabels();
      if (v) {
        addLayer(v).then(() => {
          toggleLabels();
          if (pointsLayer && map.hasLayer(pointsLayer)) {
            pointsLayer.bringToFront();
          }
        });
      }
      closePanelOnMobile();
    };

    bidangSelect.onchange = e => { loadBidang(e.target.value); closePanelOnMobile(); };

    transparencySlider.addEventListener('input', (e) => {
        currentOpacity = parseFloat(e.target.value);
        Object.values(layers).forEach(layer => {
            if (layer) layer.setStyle({ fillOpacity: currentOpacity });
        });
    });

    pointsToggle.addEventListener('change', (e) => {
        if (e.target.checked) {
            if (pointsLayer) {
                map.addLayer(pointsLayer);
                pointsLayer.bringToFront();
            } else {
                fetch(DATA_DIR + 'titiksample.geojson')
                    .then(res => res.json())
                    .then(data => {
                        pointsLayer = L.geoJSON(data, {
                            pointToLayer: (feature, latlng) => L.circleMarker(latlng, {
                                radius: 5, fillColor: "#ff7800", color: "#000",
                                weight: 1, opacity: 1, fillOpacity: 0.8
                            }),
                            onEachFeature: (feature, layer) => {
                                let popupContent = '<b>Info Sampel</b><br>';
                                for (const key in feature.properties) {
                                    popupContent += `${key}: ${feature.properties[key]}<br>`;
                                }
                                layer.bindPopup(popupContent);
                            }
                        }).addTo(map);
                        pointsLayer.bringToFront();
                    })
                    .catch(err => alert('Gagal memuat titiksample.geojson: ' + err));
            }
        } else {
            if (pointsLayer) map.removeLayer(pointsLayer);
        }
        closePanelOnMobile();
    });
    
    labelsToggle.addEventListener('change', () => {
        toggleLabels();
        closePanelOnMobile();
    });

    map.on('click', () => { document.getElementById('panel').classList.remove('open'); });
    map.on('locationfound', (e) => { L.marker(e.latlng).addTo(map).bindPopup(`Anda berada di sini.`).openPopup(); });
    map.on('locationerror', (e) => { alert("Gagal mendapatkan lokasi: " + e.message); });
  })();
</script>
</body>
</html>
